<script>
(function(){
  // Tahun otomatis
  const y = document.getElementById('year'); if (y) y.textContent = new Date().getFullYear();

  const el = (id)=>document.getElementById(id);
  const src = el('src'), dst = el('dst');
  const copyBtn = el('copyBtn'), clearBtn = el('clearBtn'), shareBtn = el('shareBtn'), downloadBtn = el('downloadBtn');
  const endOnly = el('endOnly'), strict = el('strict'), upper = el('upper');
  const srcChars = el('srcChars'), srcWords = el('srcWords'), dstChars = el('dstChars'), how = el('how');
  const modeIdToUm = el('modeIdToUm'), modeUmToId = el('modeUmToId');
  const endOnlyWrap = el('endOnlyWrap'), strictWrap = el('strictWrap');

  function isLetter(ch){ return /[A-Za-z]/.test(ch); }
  function isVowel(ch){ return /[AEIOUaeiou]/.test(ch); }

  // Aturan vokal terbaru (A → AIDEN)
  const vokalMap = {
    A:'AIDEN', a:'aiden',
    I:'IPRI',  i:'ipri',
    U:'UPRU',  u:'upru',
    E:'EPRE',  e:'epre',
    O:'OPRO',  o:'opro'
  };

  function plusEs(ch, up){
    const base = up ? ch.toUpperCase() : ch.toLowerCase();
    return base + (up ? 'ES' : 'es');
  }

  // ENCODE: Indonesia → Umandana  (per huruf, deteksi 'ng')
  function encodeUmandana(input){
    if(!input) return '';
    const up = upper.checked;
    const useEndOnly = endOnly && endOnly.checked && !(strict && strict.checked);

    const tokens = input.split(/(\s+)/); // pertahankan spasi
    const out = tokens.map(tok=>{
      if (/^\s+$/.test(tok)) return tok;

      const parts = tok.match(/[A-Za-z]+|[^A-Za-z]+/g) || [tok];
      const conv = parts.map(part=>{
        if(!/[A-Za-z]/.test(part)) return part;

        let res = '';
        const L = part.split('');
        for(let i=0;i<L.length;i++){
          const ch = L[i], next = L[i+1] || '';

          // NG -> STRENG (case-insensitive)
          if( (ch==='N'||ch==='n') && (next==='G'||next==='g') ){
            res += up ? 'STRENG' : 'streng';
            i++; // skip G
            continue;
          }

          // Vokal
          if(isVowel(ch)){
            res += vokalMap[ch] ?? ch;
            continue;
          }

          // Konsonan
          if(isLetter(ch)){
            if(strict && strict.checked){
              res += plusEs(ch, up);
            }else{
              res += up ? ch.toUpperCase() : ch.toLowerCase();
            }
            continue;
          }

          res += ch;
        }

        // ES di konsonan akhir kata (mode endOnly)
        if(useEndOnly){
          const lastAlpha = (part.match(/[A-Za-z](?=[^A-Za-z]*$)/)||[''])[0];
          if(lastAlpha && !isVowel(lastAlpha)){
            const endsWithStreng = res.endsWith(up?'STRENG':'streng');
            if(!endsWithStreng) res += up ? 'ES' : 'es';
          }
        }
        return res;
      });

      return conv.join('');
    });

    return out.join('');
  }

  // DECODE: Umandana → Indonesia (kembalikan pola khas)
  function decodeUmandana(input){
    if(!input) return '';

    const tokens = input.split(/(\s+)/);
    const out = tokens.map(tok=>{
      if(/^\s+$/.test(tok)) return tok;

      const parts = tok.match(/[A-Za-z]+|[^A-Za-z]+/g) || [tok];
      const conv = parts.map(part=>{
        if(!/[A-Za-z]/.test(part)) return part;

        let s = part;

        // 1) STRENG -> NG
        s = s.replace(/streng/gi,'NG');

        // 2) Vokal (urutkan yang unik/panjang dulu)
        s = s.replace(/aiden/gi,'A')
             .replace(/ipri/gi,'I')
             .replace(/upru/gi,'U')
             .replace(/epre/gi,'E')
             .replace(/opro/gi,'O');

        // 3) Hilangkan ES setelah konsonan
        s = s.replace(/([bcdfghjklmnpqrstvwxyz])es/gi,'$1');

        return s;
      });

      return conv.join('');
    });

    return out.join('');
  }

  function syncOptionsVisibility(){
    const decoding = modeUmToId && modeUmToId.checked;
    if(endOnly){ endOnly.disabled = decoding; endOnlyWrap && (endOnlyWrap.style.opacity = decoding?0.6:1); }
    if(strict){ strict.disabled  = decoding; strictWrap  && (strictWrap.style.opacity  = decoding?0.6:1); }
  }

  function update(){
    const val = src.value || '';
    const out = (modeUmToId && modeUmToId.checked) ? decodeUmandana(val) : encodeUmandana(val);
    dst.value = (upper && upper.checked) ? out.toUpperCase() : out;

    // counter
    srcChars && (srcChars.textContent = String(val.length));
    srcWords && (srcWords.textContent = val.trim()? String(val.trim().split(/\s+/).length) : '0');
    dstChars && (dstChars.textContent = String(dst.value.length));

    // efek kecil
    dst.classList.remove('bubble'); void dst.offsetWidth; dst.classList.add('bubble');
  }

  // events
  src.addEventListener('input', update);
  if(endOnly) endOnly.addEventListener('change', update);
  if(strict)  strict.addEventListener('change', ()=>{ if(strict.checked) endOnly.checked=false; update(); });
  if(upper)   upper.addEventListener('change', update);
  if(modeIdToUm) modeIdToUm.addEventListener('change', ()=>{ syncOptionsVisibility(); update(); });
  if(modeUmToId) modeUmToId.addEventListener('change', ()=>{ syncOptionsVisibility(); update(); });

  clearBtn.addEventListener('click', ()=>{ src.value=''; update(); src.focus(); });
  copyBtn.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(dst.value); alert('Hasil disalin!'); } catch(e){ alert('Gagal menyalin: '+e.message); }});
  shareBtn.addEventListener('click', async ()=>{ const text = dst.value || ''; if(navigator.share){ try{ await navigator.share({title:'Umandana',text}); } catch(e){} } else { alert('Peramban belum mendukung tombol Bagikan. Silakan salin teks.'); }});
  downloadBtn.addEventListener('click', ()=>{ const blob = new Blob([dst.value], {type:'text/plain;charset=utf-8'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'umandana.txt'; a.click(); URL.revokeObjectURL(url); });

  if(how) how.addEventListener('click', (e)=>{
    e.preventDefault();
    const contoh = [
      ['RUMAH','RUPRU MAHES'],
      ['ASING','AIDEN SIPRI STRENG'],
      ['MATA','MAIDEN TAIDEN'],
      ['BOLA','BOPRO LAIDEN'],
      ['DUNIA','DUPRU NIPRI AIDEN']
    ].map(([a,b])=>`• ${a} → ${b}`).join('\n');
    alert('Contoh:\n'+contoh+'\n\nAturan:\nA→AIDEN\nI→IPRI\nU→UPRU\nE→EPRE\nO→OPRO\nNG→STRENG\nKonsonan +ES');
  });

  // seed demo (set dulu baru update)
  src.value = 'KITA PERGI MAKAN DI RUMAH TEMAN MALAM INI';
  syncOptionsVisibility();
  update();
})();
</script>
